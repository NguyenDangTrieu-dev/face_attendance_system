<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Giáº£ng ViÃªn</title>

    <!-- CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        background-color: #f8f9fa;
      }
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 250px;
        background-color: #343a40;
        padding-top: 60px;
        color: #fff;
      }
      .sidebar h5 {
        padding-left: 20px;
        margin-bottom: 30px;
      }
      .sidebar a {
        padding: 12px 20px;
        display: block;
        color: #fff;
        text-decoration: none;
      }
      .sidebar a:hover {
        background-color: #495057;
      }

      .main-content {
        margin-left: 250px;
        padding: 20px;
        width: calc(100% - 250px);
        min-height: 100vh;
      }
      .card-header {
        background-color: #0d6efd;
        color: #fff;
      }
      .list-group-item {
        border-left: 4px solid #0d6efd;
      }

      #attendance-video {
        width: 720px;
        height: auto;
        border-radius: 8px;
      }
      #attendance-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 720px;
        height: auto;
        pointer-events: none;
      }

      /* Course modal layout */
      #courseModal .row {
        display: flex;
        gap: 10px;
      }
      #courseModal .col {
        flex: 1;
      }

      /* Import modal */
      #importStudentsModal .form-label {
        font-weight: 600;
      }
      #importStudentsModal .form-text {
        font-size: 0.875rem;
        color: #6c757d;
      }
      #importStudentsModal .btn-success {
        font-weight: 500;
      }
    </style>

    <!-- JS libs (LOAD ONCE) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  </head>

  <body>
    <!-- ======================= MODALS ======================= -->

    <!-- Face Register Modal -->
    <div
      class="modal fade"
      id="faceModal"
      tabindex="-1"
      aria-labelledby="faceModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="faceModalLabel">ÄÄƒng kÃ½ khuÃ´n máº·t</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ÄÃ³ng"
            ></button>
          </div>
          <div class="modal-body text-center">
            <video
              id="video"
              autoplay
              playsinline
              width="100%"
              style="max-height: 400px; border-radius: 8px"
            ></video>
            <canvas id="canvas" style="display: none"></canvas>
            <p class="mt-3" id="register-status"></p>
            <button class="btn btn-primary mt-2" id="btn-start-register">
              Báº¯t Ä‘áº§u Ä‘Äƒng kÃ½
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance realtime modal -->
    <div
      class="modal fade"
      id="attendance-modal"
      tabindex="-1"
      aria-labelledby="attendanceModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content shadow-lg rounded-4">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="attendanceModalLabel">
              Äiá»ƒm danh realtime báº±ng khuÃ´n máº·t
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              aria-label="ÄÃ³ng"
              id="btn-close-attendance-x"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div class="position-relative d-inline-block mx-auto">
              <img
                id="attendance-stream"
                src=""
                alt="Realtime Attendance Stream"
                style="
                  width: 100%;
                  max-width: 720px;
                  background: #000;
                  border-radius: 8px;
                  border: 2px solid #0d6efd;
                "
                onload="this.style.background='transparent'"
                onerror="this.src=''; setTimeout(() => { this.src = '/video_feed?' + Date.now(); }, 1000);"
              />
            </div>
            <div class="mt-3">
              <button class="btn btn-danger" id="btn-close-attendance">
                ÄÃ³ng
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Modal for Student Management -->
    <div class="modal fade" id="cameraModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“¸ ÄÄƒng kÃ½ khuÃ´n máº·t</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body text-center">
            <div class="position-relative d-inline-block">
              <video
                id="camera-video"
                autoplay
                playsinline
                class="w-100 rounded"
                style="max-height: 480px; border: 2px solid #0d6efd"
              ></video>
              <canvas
                id="face-overlay-canvas"
                style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  pointer-events: none;
                "
              ></canvas>
            </div>
            <canvas id="camera-canvas" class="d-none"></canvas>

            <p id="camera-status" class="mt-3 text-muted">
              Äang khá»Ÿi Ä‘á»™ng camera...
            </p>

            <button class="btn btn-primary mt-2" id="btn-start-capture">
              â–¶ Báº¯t Ä‘áº§u chá»¥p 10 áº£nh
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- QR Modal -->
    <div
      class="modal fade"
      id="qrModal"
      tabindex="-1"
      aria-labelledby="qrModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow rounded-4">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="qrModalLabel">
              QuÃ©t mÃ£ QR Ä‘á»ƒ Ä‘iá»ƒm danh
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="ÄÃ³ng"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div id="qr-container" class="mb-3"></div>
            <p>HÃ£y dÃ¹ng á»©ng dá»¥ng Ä‘iá»ƒm danh Ä‘á»ƒ quÃ©t mÃ£ QR nÃ y.</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              ÄÃ³ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Course Modal -->
    <div
      class="modal fade"
      id="courseModal"
      tabindex="-1"
      aria-labelledby="courseModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="courseModalLabel">
              ğŸ“˜ ThÃªm/Sá»­a khÃ³a há»c
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="ÄÃ³ng"
            ></button>
          </div>
          <div class="modal-body">
            <form id="courseForm">
              <input type="hidden" id="courseId" />
              <div class="mb-3">
                <label for="courseName" class="form-label">TÃªn khÃ³a há»c</label>
                <input
                  type="text"
                  class="form-control"
                  id="courseName"
                  required
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Há»c ká»³</label>
                <div class="row">
                  <div class="col">
                    <select class="form-select" id="courseSemester" required>
                      <option value="" disabled selected>Chá»n há»c ká»³</option>
                      <option value="HK1">HK1</option>
                      <option value="HK2">HK2</option>
                    </select>
                  </div>
                  <div class="col">
                    <select class="form-select" id="courseYear" required>
                      <option value="" disabled selected>Chá»n nÄƒm</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="lecturerId" class="form-label">ID Giáº£ng viÃªn</label>
                <input
                  type="text"
                  class="form-control"
                  id="lecturerId"
                  value="{{ user.user_id }}"
                  readonly
                />
              </div>

              <button type="submit" class="btn btn-primary">LÆ°u</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Import Students Modal -->
    <div
      class="modal fade"
      id="importStudentsModal"
      tabindex="-1"
      aria-labelledby="importStudentsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="importStudentsModalLabel">
              ğŸ“¥ Import Sinh viÃªn tá»« Excel
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="ÄÃ³ng"
            ></button>
          </div>
          <div class="modal-body">
            <form id="importStudentsForm">
              <div class="mb-3">
                <label for="studentFile" class="form-label"
                  >Chá»n file Excel</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="studentFile"
                  accept=".xlsx,.xls"
                  required
                />
                <small class="form-text text-muted">
                  File pháº£i chá»©a cÃ¡c cá»™t: <code>student_id</code>,
                  <code>full_name</code>, <code>password</code>.
                </small>
              </div>
              <button type="submit" class="btn btn-success w-100">
                Táº£i lÃªn
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================= SIDEBAR ======================= -->
    <div class="sidebar">
      <h5>Giáº£ng viÃªn: {{ user.full_name }}</h5>

      <a href="#" onclick="showTab('courses')">ğŸ“š KhÃ³a há»c</a>
      <a href="#" onclick="showTab('attendance')">ğŸ•‘ Lá»‹ch sá»­ Ä‘iá»ƒm danh</a>

      <hr />

      <a href="#" onclick="showTab('student-manage')"> ğŸ‘¨â€ğŸ“ Quáº£n lÃ½ sinh viÃªn </a>

      <hr />
      <a href="/logout" class="text-danger">ÄÄƒng xuáº¥t</a>
    </div>

    <!-- ======================= MAIN ======================= -->
    <div class="main-content">
      <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="tab-courses"
            data-bs-toggle="tab"
            data-bs-target="#courses"
            type="button"
            role="tab"
          >
            KhÃ³a há»c
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-students"
            data-bs-toggle="tab"
            data-bs-target="#students"
            type="button"
            role="tab"
          >
            Sinh viÃªn
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-attendance"
            data-bs-toggle="tab"
            data-bs-target="#attendance"
            type="button"
            role="tab"
          >
            Lá»‹ch sá»­ Ä‘iá»ƒm danh
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="tab-statistics"
            data-bs-toggle="tab"
            data-bs-target="#statistics"
            type="button"
            role="tab"
          >
            ğŸ“Š Thá»‘ng kÃª
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="tab-student-manage"
            data-bs-toggle="tab"
            data-bs-target="#student-manage"
            type="button"
          >
            ğŸ‘¨â€ğŸ“ Quáº£n lÃ½ sinh viÃªn
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <!-- COURSES -->
        <div class="tab-pane fade show active" id="courses" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>ğŸ“˜ Danh sÃ¡ch khÃ³a há»c</h5>
            <button class="btn btn-primary" id="btn-open-course-modal">
              â• ThÃªm khÃ³a há»c
            </button>
          </div>
          <div id="course-list" class="row"></div>
        </div>

        <!-- STUDENTS -->
        <div class="tab-pane fade" id="students" role="tabpanel">
          <div
            class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"
          >
            <h5 id="student-title" class="mb-0">ğŸ§‘â€ğŸ“ Danh sÃ¡ch sinh viÃªn</h5>

            <div class="d-flex gap-2">
              <button class="btn btn-primary" id="btn-open-attendance">
                ğŸ•µï¸â€â™‚ï¸ Äiá»ƒm danh realtime
              </button>
              <button class="btn btn-outline-success" id="btn-show-qr">
                ğŸ“· Hiá»‡n mÃ£ QR
              </button>
              <button class="btn btn-success" id="btn-open-import">
                ğŸ“¥ Import Sinh viÃªn
              </button>
            </div>
          </div>
          <div id="student-list" class="list-group"></div>
        </div>

        <!-- ATTENDANCE -->
        <div class="tab-pane fade" id="attendance" role="tabpanel">
          <h5 id="attendance-title" class="mb-3"></h5>
          <div id="attendance-list" class="list-group"></div>
        </div>

        <!-- STATISTICS -->
        <div class="tab-pane fade" id="statistics" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>ğŸ“Š Thá»‘ng kÃª Ä‘iá»ƒm danh</h5>
            <button class="btn btn-secondary" id="btn-export-stat">
              ğŸ“¤ Xuáº¥t Excel
            </button>
          </div>

          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>MÃ£ SV</th>
                <th>Há» tÃªn</th>
                <th>Sá»‘ buá»•i Ä‘i há»c</th>
                <th>Sá»‘ buá»•i váº¯ng</th>
                <th>Tá»‰ lá»‡ Ä‘i há»c</th>
              </tr>
            </thead>
            <tbody id="statistics-body"></tbody>
          </table>

          <h5 class="mt-4">ğŸ“ˆ Biá»ƒu Ä‘á»“ tá»‰ lá»‡ Ä‘iá»ƒm danh</h5>
          <canvas id="attendanceChart" width="400" height="200"></canvas>
        </div>

        <!-- ================= STUDENT MANAGE ================= -->
        <div class="tab-pane fade" id="student-manage" role="tabpanel">
          <h5 class="mb-3">ğŸ‘¨â€ğŸ“ Quáº£n lÃ½ sinh viÃªn toÃ n há»‡ thá»‘ng</h5>

          <div class="row g-4">
            <!-- ===== CÃCH 1: CAMERA ===== -->
            <div class="col-md-6">
              <div class="card shadow-sm">
                <div class="card-header fw-bold">
                  ğŸ“¸ ÄÄƒng kÃ½ sinh viÃªn báº±ng camera
                </div>
                <div class="card-body">
                  <form id="form-register-camera">
                    <div class="mb-2">
                      <label class="form-label">MÃ£ sá»‘ sinh viÃªn</label>
                      <input
                        type="text"
                        class="form-control"
                        name="student_id"
                        id="manage-student-id"
                        required
                      />
                    </div>

                    <div class="mb-2">
                      <label class="form-label">Há» vÃ  tÃªn</label>
                      <input
                        type="text"
                        class="form-control"
                        name="name"
                        id="manage-student-name"
                        required
                      />
                    </div>

                    <button
                      class="btn btn-primary w-100"
                      type="button"
                      id="btn-open-camera"
                    >
                      ğŸ“¸ Má»Ÿ camera & tá»± chá»¥p 10 áº£nh
                    </button>
                  </form>

                  <div id="camera-result" class="mt-3 small"></div>
                </div>
              </div>
            </div>

            <!-- ===== CÃCH 2: ZIP ===== -->
            <div class="col-md-6">
              <div class="card shadow-sm">
                <div class="card-header fw-bold">
                  ğŸ“¦ Import sinh viÃªn báº±ng ZIP
                </div>
                <div class="card-body">
                  <p class="small text-muted">
                    Cáº¥u trÃºc ZIP:
                    <br />
                    <code>MSSV-HoTen/1.jpg, 2.jpg, ...</code>
                  </p>

                  <form id="form-register-zip">
                    <input
                      type="file"
                      class="form-control mb-3"
                      name="zip"
                      accept=".zip"
                      required
                    />

                    <button class="btn btn-success w-100" type="submit">
                      ğŸ“¥ Import ZIP
                    </button>
                  </form>

                  <div id="zip-result" class="mt-3 small"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (LOAD ONCE at end) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      /* ======================= STATE ======================= */
      const lecturerId = "{{ user.user_id }}";

      let currentCourseId = null;
      let currentCourseName = "";
      let lastLoadedCourseId = null;
      let isFetchingAttendance = false;

      let currentStudentId = null;
      let currentStudentName = null;
      let stream = null;
      let cameraStream = null;

      let attendanceChart = null;

      /* ======================= HELPERS ======================= */
      function qs(id) {
        return document.getElementById(id);
      }

      function showTab(tabId) {
        const btn = qs("tab-" + tabId);
        if (!btn) return;
        new bootstrap.Tab(btn).show();
      }

      function showToast(message, type = "success") {
        let toastContainer = qs("toastContainer");
        if (!toastContainer) {
          toastContainer = document.createElement("div");
          toastContainer.id = "toastContainer";
          toastContainer.className =
            "toast-container position-fixed top-0 end-0 p-3";
          document.body.appendChild(toastContainer);
        }

        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");
        toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;

        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        setTimeout(() => {
          bsToast.hide();
          toast.remove();
        }, 3000);
      }

      async function setupWebcam(videoElement) {
        try {
          const s = await navigator.mediaDevices.getUserMedia({ video: true });
          videoElement.srcObject = s;
          await new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
              videoElement.play();
              resolve();
            };
          });
          return s;
        } catch (err) {
          alert("KhÃ´ng thá»ƒ truy cáº­p webcam!");
          console.error("Webcam error:", err);
          throw err;
        }
      }

      /* ======================= COURSES ======================= */
      function loadCourses() {
        fetch(`/api/lecturer/${lecturerId}/courses`)
          .then((res) => res.json())
          .then((data) => {
            const courseList = qs("course-list");
            courseList.innerHTML = "";

            data.forEach((course) => {
              const col = document.createElement("div");
              col.className = "col-md-6 mb-3";
              col.innerHTML = `
              <div class="card shadow-sm">
                <div class="card-header">
                  <h5 class="card-title mb-0">${course.name}</h5>
                </div>
                <div class="card-body">
                  <p><strong>Há»c ká»³:</strong> ${course.semester}</p>

                  <button class="btn btn-outline-primary btn-sm"
                    onclick="loadStudents(${
                      course.id
                    }, '${course.name.replaceAll("'", "\\'")}')">
                    ğŸ‘¨â€ğŸ“ Xem SV
                  </button>

                  <button class="btn btn-outline-secondary btn-sm ms-2"
                    onclick="showAttendanceTab(${
                      course.id
                    }, '${course.name.replaceAll("'", "\\'")}')">
                    ğŸ“ Lá»‹ch sá»­ Ä‘iá»ƒm danh
                  </button>

                  <button class="btn btn-outline-warning btn-sm ms-2"
                    onclick="openCourseModal({id: ${
                      course.id
                    }, name: '${course.name.replaceAll(
                "'",
                "\\'"
              )}', semester: '${course.semester.replaceAll("'", "\\'")}'})">
                    âœï¸ Sá»­a
                  </button>

                  <button class="btn btn-outline-danger btn-sm ms-2"
                    onclick="deleteCourse(${course.id})">
                    ğŸ—‘ï¸ XÃ³a
                  </button>
                </div>
              </div>
            `;
              courseList.appendChild(col);
            });
          })
          .catch((err) => {
            console.error("Lá»—i khi táº£i khÃ³a há»c:", err);
            showToast("âŒ Lá»—i táº£i danh sÃ¡ch khÃ³a há»c", "danger");
          });
      }

      /* ======================= STUDENTS ======================= */
      function loadStudents(courseId, courseName) {
        currentCourseId = courseId;
        currentCourseName = courseName;

        showTab("students");
        qs(
          "student-title"
        ).textContent = `ğŸ§‘â€ğŸ“ Danh sÃ¡ch sinh viÃªn - ${courseName}`;

        fetch(`/api/courses/${courseId}/students_with_embedding`)
          .then((res) => res.json())
          .then((data) => {
            const studentList = qs("student-list");
            studentList.innerHTML = "";

            data.forEach((st) => {
              const div = document.createElement("div");
              div.className =
                "list-group-item d-flex justify-content-between align-items-center";

              const info = document.createElement("span");
              info.innerHTML = `<strong>${st.id}</strong> - ${st.full_name}`;

              const btn = document.createElement("button");
              btn.className = `btn btn-sm ${
                st.has_embedding ? "btn-warning" : "btn-primary"
              }`;
              btn.textContent = st.has_embedding ? "ÄÄƒng kÃ½ láº¡i" : "ÄÄƒng kÃ½";
              btn.onclick = () => handleRegisterFace(st.id, st.full_name);

              div.appendChild(info);
              div.appendChild(btn);
              studentList.appendChild(div);
            });
          })
          .catch((err) => {
            console.error("Lá»—i táº£i sinh viÃªn:", err);
            showToast("âŒ Lá»—i táº£i danh sÃ¡ch sinh viÃªn", "danger");
          });
      }

      /* ======================= FACE REGISTER ======================= */
      async function handleRegisterFace(studentId, fullName) {
        currentStudentId = studentId;
        currentStudentName = fullName;

        const modal = new bootstrap.Modal(qs("faceModal"));
        modal.show();

        const video = qs("video");
        const status = qs("register-status");

        status.innerHTML = "";
        try {
          stream = await setupWebcam(video);
        } catch (e) {
          status.innerHTML =
            "<span class='text-danger'>KhÃ´ng thá»ƒ truy cáº­p webcam</span>";
        }
      }

      function captureAndSend() {
        const video = qs("video");
        const canvas = qs("canvas");
        const status = qs("register-status");
        const ctx = canvas.getContext("2d");

        const capturedImages = [];
        let count = 0;
        const totalCaptures = 10;
        const delay = 600;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        status.innerHTML = "<span class='text-info'>Äang chá»¥p áº£nh...</span>";

        const capture = () => {
          ctx.drawImage(video, 0, 0);
          canvas.toBlob((blob) => {
            capturedImages.push(blob);
            count++;

            if (count < totalCaptures) {
              setTimeout(capture, delay);
            } else {
              const formData = new FormData();
              formData.append("student_id", currentStudentId);
              formData.append("name", currentStudentName);
              capturedImages.forEach((b, i) =>
                formData.append("files", b, `frame_${i}.jpg`)
              );

              fetch("/register", { method: "POST", body: formData })
                .then((res) => res.json())
                .then((result) => {
                  if (result.success) {
                    status.innerHTML =
                      "<span class='text-success'>ÄÄƒng kÃ½ thÃ nh cÃ´ng!</span>";
                    if (currentCourseId)
                      loadStudents(currentCourseId, currentCourseName);
                  } else {
                    status.innerHTML = `<span class='text-danger'>ÄÄƒng kÃ½ tháº¥t báº¡i: ${result.message}</span>`;
                  }
                })
                .catch((err) => {
                  console.error(err);
                  status.innerHTML =
                    "<span class='text-danger'>Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§</span>";
                });
            }
          }, "image/jpeg");
        };

        capture();
      }

      /* stop webcam when close face modal */
      qs("faceModal").addEventListener("hidden.bs.modal", () => {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
      });

      /* ======================= ATTENDANCE HISTORY ======================= */
      function groupAttendanceByDate(data) {
        const groups = {};

        data.forEach((att) => {
          const date = new Date(att.time).toLocaleDateString("vi-VN", {
            timeZone: "Asia/Ho_Chi_Minh",
          });

          if (!groups[date]) groups[date] = [];
          groups[date].push(att);
        });

        return groups;
      }

      function showAttendanceTab(courseId, courseName) {
        currentCourseId = courseId;
        currentCourseName = courseName;
        showTab("attendance");
        loadAttendance(courseId, courseName);
      }

      function loadAttendance(courseId, courseName) {
        if (isFetchingAttendance) return;

        if (lastLoadedCourseId === courseId) {
          qs(
            "attendance-title"
          ).textContent = `ğŸ“Œ Lá»‹ch sá»­ Ä‘iá»ƒm danh - ${courseName}`;
          return;
        }

        isFetchingAttendance = true;
        qs(
          "attendance-title"
        ).textContent = `ğŸ“Œ Lá»‹ch sá»­ Ä‘iá»ƒm danh - ${courseName}`;

        const list = qs("attendance-list");
        list.innerHTML = "<p>â³ Äang táº£i dá»¯ liá»‡u...</p>";

        fetch(`/api/courses/${courseId}/attendance`)
          .then((res) => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
          })
          .then((data) => {
            lastLoadedCourseId = courseId;
            list.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
              list.innerHTML = "<p>KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh.</p>";
              return;
            }

            const grouped = groupAttendanceByDate(data);

            Object.keys(grouped)
              .sort((a, b) => {
                const da = new Date(a.split("/").reverse().join("-"));
                const db = new Date(b.split("/").reverse().join("-"));
                return db - da;
              })
              .forEach((date) => {
                const dateDiv = document.createElement("div");
                dateDiv.className = "fw-bold mt-4 mb-2 text-primary";
                dateDiv.innerHTML = `ğŸ“… ${date}`;
                list.appendChild(dateDiv);

                grouped[date].forEach((att) => {
                  const recognized = Boolean(att.recognized);

                  const div = document.createElement("div");
                  div.className = "list-group-item ms-3";

                  div.innerHTML = `
      <div class="d-flex align-items-center gap-3">
        <img src="${
          att.image_base64
            ? `data:image/jpeg;base64,${att.image_base64}`
            : "/static/img/no-face.png"
        }"
          width="70" height="70"
          class="rounded"
          style="object-fit:cover"
        >
        <div>
          <strong>${att.name}</strong><br>
          <small>
            ${new Date(att.time).toLocaleTimeString("vi-VN", {
              timeZone: "Asia/Ho_Chi_Minh",
            })}
          </small><br>
          ${
            recognized
              ? "<span class='text-success'>âœ… ÄÃ£ nháº­n diá»‡n</span>"
              : "<span class='text-danger'>âŒ ChÆ°a nháº­n</span>"
          }
        </div>
      </div>
    `;
                  list.appendChild(div);
                });
              });
          })
          .catch((err) => {
            console.error("Error loading attendance:", err);
            list.innerHTML = `<p class="text-danger">Lá»—i táº£i dá»¯ liá»‡u Ä‘iá»ƒm danh</p>`;
          })
          .finally(() => {
            isFetchingAttendance = false;
          });
      }

      /* ======================= QR ======================= */
      function showQR(courseId, courseName) {
        const qrContainer = qs("qr-container");
        qrContainer.innerHTML = "";

        const img = document.createElement("img");
        img.src = `/api/qr_ip?course_id=${encodeURIComponent(
          courseId
        )}&course_name=${encodeURIComponent(courseName)}`;
        img.alt = "QR chá»©a thÃ´ng tin Ä‘iá»ƒm danh";
        img.style.width = "256px";
        img.style.height = "256px";

        img.onload = () => {
          qrContainer.appendChild(img);
          new bootstrap.Modal(qs("qrModal")).show();
        };
        img.onerror = () => {
          qrContainer.innerHTML =
            "<p class='text-danger'>Lá»—i: KhÃ´ng thá»ƒ táº£i mÃ£ QR</p>";
          new bootstrap.Modal(qs("qrModal")).show();
        };
      }

      /* ======================= REALTIME MODAL ======================= */
      async function openAttendanceModal() {
        if (!currentCourseId) {
          showToast("âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c!", "danger");
          return;
        }

        try {
          const res = await fetch("/api/realtime/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ course_id: currentCourseId }),
          });
          const data = await res.json();

          if (!data.running) {
            throw new Error("KhÃ´ng khá»Ÿi Ä‘á»™ng Ä‘Æ°á»£c engine");
          }

          const modal = new bootstrap.Modal(qs("attendance-modal"));
          modal.show();

          const streamImg = document.getElementById("attendance-stream");
          streamImg.src = "/video_feed?" + Date.now();

          const cleanup = () => {
            fetch("/api/realtime/stop", { method: "POST" }).catch(
              console.error
            );
            streamImg.src = "";
          };

          qs("attendance-modal").addEventListener("hidden.bs.modal", cleanup, {
            once: true,
          });
          qs("btn-close-attendance").onclick = cleanup;
          qs("btn-close-attendance-x").onclick = cleanup;

          showToast(
            "âœ… Äiá»ƒm danh realtime Ä‘Ã£ khá»Ÿi Ä‘á»™ng (bbox hiá»ƒn thá»‹ tá»« server)",
            "success"
          );
        } catch (err) {
          console.error("Lá»—i khá»Ÿi Ä‘á»™ng realtime:", err);
          showToast("âŒ KhÃ´ng thá»ƒ khá»Ÿi Ä‘á»™ng: " + err.message, "danger");
        }
      }

      function closeAttendanceModal() {
        const modalEl = qs("attendance-modal");
        bootstrap.Modal.getInstance(modalEl)?.hide();

        if (window.attendanceStream) {
          window.attendanceStream.getTracks().forEach((t) => t.stop());
          window.attendanceStream = null;
        }
        if (window.attendanceInterval) {
          clearInterval(window.attendanceInterval);
          window.attendanceInterval = null;
        }

        const video = qs("attendance-video");
        video.srcObject = null;

        const canvas = qs("attendance-canvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      /* ======================= COURSE CRUD ======================= */
      function populateYears() {
        const yearSelect = qs("courseYear");
        yearSelect.innerHTML =
          '<option value="" disabled selected>Chá»n nÄƒm</option>';

        const currentYear = new Date().getFullYear();
        const startYear = 2020;
        const endYear = currentYear + 1;

        for (let y = startYear; y <= endYear; y++) {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        }
      }

      function createCourse(courseData) {
        fetch("/api/courses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(courseData),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) return showToast(`âŒ Lá»—i: ${data.error}`, "danger");
            showToast("âœ… ThÃªm khÃ³a há»c thÃ nh cÃ´ng", "success");
            loadCourses();
            bootstrap.Modal.getInstance(qs("courseModal"))?.hide();
          })
          .catch((err) => {
            console.error("Lá»—i táº¡o khÃ³a há»c:", err);
            showToast("âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§", "danger");
          });
      }

      function updateCourse(courseId, courseData) {
        fetch(`/api/courses/${courseId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(courseData),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) return showToast(`âŒ Lá»—i: ${data.error}`, "danger");
            showToast("âœ… Cáº­p nháº­t khÃ³a há»c thÃ nh cÃ´ng", "success");
            loadCourses();
            bootstrap.Modal.getInstance(qs("courseModal"))?.hide();
          })
          .catch((err) => {
            console.error("Lá»—i cáº­p nháº­t khÃ³a há»c:", err);
            showToast("âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§", "danger");
          });
      }

      function deleteCourse(courseId) {
        if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a khÃ³a há»c nÃ y?")) return;

        fetch(`/api/courses/${courseId}`, { method: "DELETE" })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) return showToast(`âŒ Lá»—i: ${data.error}`, "danger");
            showToast("âœ… XÃ³a khÃ³a há»c thÃ nh cÃ´ng", "success");
            loadCourses();
          })
          .catch((err) => {
            console.error("Lá»—i xÃ³a khÃ³a há»c:", err);
            showToast("âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§", "danger");
          });
      }

      function openCourseModal(course = null) {
        populateYears();

        const modal = new bootstrap.Modal(qs("courseModal"));
        const courseIdInput = qs("courseId");
        const courseNameInput = qs("courseName");
        const semesterSelect = qs("courseSemester");
        const yearSelect = qs("courseYear");
        const title = qs("courseModalLabel");

        if (course) {
          title.textContent = "ğŸ“˜ Sá»­a khÃ³a há»c";
          courseIdInput.value = course.id;

          courseNameInput.value = course.name || "";
          const [sem, year] = (course.semester || "").split("-");
          semesterSelect.value = sem || "";
          yearSelect.value = year || "";
        } else {
          title.textContent = "ğŸ“˜ ThÃªm khÃ³a há»c";
          courseIdInput.value = "";
          courseNameInput.value = "";
          semesterSelect.value = "";
          yearSelect.value = "";
        }

        modal.show();

        qs("courseForm").onsubmit = (e) => {
          e.preventDefault();
          if (
            !courseNameInput.value ||
            !semesterSelect.value ||
            !yearSelect.value
          ) {
            showToast("âŒ Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin", "danger");
            return;
          }

          const semester = `${semesterSelect.value}-${yearSelect.value}`;
          const payload = {
            name: courseNameInput.value,
            semester,
            lecturer_id: lecturerId,
          };

          if (courseIdInput.value) updateCourse(courseIdInput.value, payload);
          else createCourse(payload);
        };
      }

      /* ======================= IMPORT STUDENTS ======================= */
      function openImportStudentsModal() {
        if (!currentCourseId) {
          showToast("âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c", "danger");
          return;
        }

        const modal = new bootstrap.Modal(qs("importStudentsModal"));
        const form = qs("importStudentsForm");
        form.reset();
        modal.show();

        form.onsubmit = (e) => {
          e.preventDefault();
          const file = qs("studentFile").files[0];
          if (!file) {
            showToast("âŒ Vui lÃ²ng chá»n file Excel", "danger");
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          fetch(`/api/courses/${currentCourseId}/import_students`, {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.error)
                return showToast(`âŒ Lá»—i: ${data.error}`, "danger");
              showToast("âœ… Import sinh viÃªn thÃ nh cÃ´ng", "success");
              loadStudents(currentCourseId, currentCourseName);
              modal.hide();
            })
            .catch((err) => {
              console.error("Lá»—i import:", err);
              showToast("âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§", "danger");
            });
        };
      }

      /* ======================= STATISTICS ======================= */
      function loadStatistics(courseId) {
        if (!courseId) {
          showToast("âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c", "danger");
          return;
        }

        const tbody = qs("statistics-body");
        tbody.innerHTML = `<tr><td colspan="5">â³ Äang táº£i dá»¯ liá»‡u...</td></tr>`;

        fetch(`/api/courses/${courseId}/attendance/summary`)
          .then((res) => {
            if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
            return res.json();
          })
          .then((data) => {
            tbody.innerHTML = "";

            if (!Array.isArray(data) || data.length === 0) {
              showToast("â„¹ï¸ KhÃ³a há»c chÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh.", "info");
              return;
            }

            const labels = data.map((x) => x.full_name);
            const ratioData = data.map((x) => {
              const total = x.attended + x.absent;
              return total === 0 ? 0 : +((x.attended / total) * 100).toFixed(2);
            });

            data.forEach((stat) => {
              const total = stat.attended + stat.absent;
              const ratio =
                total === 0 ? 0 : ((stat.attended / total) * 100).toFixed(2);

              const row = document.createElement("tr");
              row.innerHTML = `
              <td>${stat.student_id}</td>
              <td>${stat.full_name}</td>
              <td>${stat.attended}</td>
              <td>${stat.absent}</td>
              <td>${ratio}%</td>
            `;
              tbody.appendChild(row);
            });

            const ctx = qs("attendanceChart").getContext("2d");
            if (attendanceChart) attendanceChart.destroy();

            attendanceChart = new Chart(ctx, {
              type: "line",
              data: {
                labels,
                datasets: [
                  {
                    label: "Tá»‰ lá»‡ Ä‘i há»c (%)",
                    data: ratioData,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { position: "top" },
                  title: {
                    display: true,
                    text: "Biá»ƒu Ä‘á»“ tá»‰ lá»‡ sinh viÃªn Ä‘i há»c (%)",
                  },
                  tooltip: {
                    callbacks: { label: (c) => `${c.raw}%` },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100,
                    title: { display: true, text: "Tá»‰ lá»‡ (%)" },
                  },
                  x: {
                    ticks: {
                      maxRotation: 45,
                      minRotation: 45,
                      autoSkip: false,
                    },
                  },
                },
              },
            });
          })
          .catch((err) => {
            console.error("Lá»—i khi táº£i thá»‘ng kÃª:", err);
            showToast("âŒ Lá»—i táº£i dá»¯ liá»‡u thá»‘ng kÃª", "danger");
          });
      }

      function exportStatistics() {
        if (!currentCourseId) {
          showToast("âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c", "danger");
          return;
        }

        const tbody = qs("statistics-body");
        const rows = tbody.getElementsByTagName("tr");
        if (!rows.length || tbody.textContent.includes("Äang táº£i")) {
          showToast("âŒ ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª Ä‘á»ƒ xuáº¥t", "danger");
          return;
        }

        const data = [
          [
            "MÃ£ SV",
            "Há» tÃªn",
            "Sá»‘ buá»•i Ä‘i há»c",
            "Sá»‘ buá»•i váº¯ng",
            "Tá»‰ lá»‡ Ä‘i há»c (%)",
          ],
        ];
        for (const row of rows) {
          const cols = row.querySelectorAll("td");
          if (!cols.length) continue;
          data.push(Array.from(cols).map((td) => td.textContent.trim()));
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        ws["!cols"] = data[0].map((_, i) => {
          const maxLen = Math.max(
            ...data.map((r) => (r[i] ? String(r[i]).length : 0))
          );
          return { wch: maxLen + 2 };
        });

        XLSX.utils.book_append_sheet(wb, ws, "ThongKeDiemDanh");

        const dateStr = new Date()
          .toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" })
          .replace(/[,/:]/g, "-");

        XLSX.writeFile(
          wb,
          `ThongKe_DiemDanh_${currentCourseName}_${currentCourseId}_${dateStr}.xlsx`
        );
        showToast("âœ… Xuáº¥t file Excel thÃ nh cÃ´ng", "success");
      }

      /* ======================= CAMERA REGISTRATION (STUDENT MANAGE) ======================= */

      // Load face-api.js models (sá»­ dá»¥ng TinyFaceDetector cho tá»‘c Ä‘á»™)
      let faceApiLoaded = false;

      async function loadFaceApiModels() {
        if (faceApiLoaded) return;

        try {
          const MODEL_URL =
            "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model";
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
          faceApiLoaded = true;
          console.log("âœ… Face-API models loaded");
        } catch (err) {
          console.error("âŒ Error loading face-api models:", err);
        }
      }

      // Váº½ bbox realtime
      let faceDetectionInterval = null;

      async function drawFaceBoxes(video, canvas) {
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const detections = await faceapi.detectAllFaces(
          video,
          new faceapi.TinyFaceDetectorOptions({
            inputSize: 224,
            scoreThreshold: 0.5,
          })
        );

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (detections.length > 0) {
          detections.forEach((det) => {
            const box = det.box;
            ctx.strokeStyle = "#0d6efd";
            ctx.lineWidth = 3;
            ctx.strokeRect(box.x, box.y, box.width, box.height);

            // Váº½ text
            ctx.fillStyle = "#0d6efd";
            ctx.font = "bold 16px Arial";
            ctx.fillText("Face Detected", box.x, box.y - 10);
          });
        }
      }

      qs("btn-open-camera").addEventListener("click", async () => {
        const studentId = qs("manage-student-id").value.trim();
        const name = qs("manage-student-name").value.trim();

        if (!studentId || !name) {
          showToast("âŒ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ MSSV vÃ  há» tÃªn", "danger");
          return;
        }

        // Load face-api models
        await loadFaceApiModels();

        // Má»Ÿ modal camera
        const modal = new bootstrap.Modal(qs("cameraModal"));
        modal.show();

        // Báº­t camera
        const video = qs("camera-video");
        const overlayCanvas = qs("face-overlay-canvas");
        const status = qs("camera-status");

        try {
          cameraStream = await setupWebcam(video);
          status.textContent =
            "âœ… Camera Ä‘Ã£ sáºµn sÃ ng. HÃ£y Ä‘Æ°a khuÃ´n máº·t vÃ o khung hÃ¬nh.";

          // Báº¯t Ä‘áº§u váº½ bbox realtime
          if (faceApiLoaded) {
            faceDetectionInterval = setInterval(() => {
              drawFaceBoxes(video, overlayCanvas);
            }, 100);
          }
        } catch (err) {
          status.innerHTML =
            "<span class='text-danger'>âŒ KhÃ´ng thá»ƒ má»Ÿ camera</span>";
          console.error(err);
        }
      });

      // Stop camera khi Ä‘Ã³ng modal
      qs("cameraModal").addEventListener("hidden.bs.modal", () => {
        if (cameraStream) {
          cameraStream.getTracks().forEach((t) => t.stop());
          cameraStream = null;
        }

        if (faceDetectionInterval) {
          clearInterval(faceDetectionInterval);
          faceDetectionInterval = null;
        }

        const video = qs("camera-video");
        video.srcObject = null;

        const overlayCanvas = qs("face-overlay-canvas");
        const ctx = overlayCanvas.getContext("2d");
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

        qs("camera-status").textContent = "Äang khá»Ÿi Ä‘á»™ng camera...";
      });

      // Báº¯t Ä‘áº§u chá»¥p áº£nh (CROP FACE)
      qs("btn-start-capture").addEventListener("click", async () => {
        const studentId = qs("manage-student-id").value.trim();
        const name = qs("manage-student-name").value.trim();
        const video = qs("camera-video");
        const canvas = qs("camera-canvas");
        const ctx = canvas.getContext("2d");
        const status = qs("camera-status");
        const result = qs("camera-result");

        // Dá»«ng váº½ bbox
        if (faceDetectionInterval) {
          clearInterval(faceDetectionInterval);
          faceDetectionInterval = null;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const images = [];
        let successCount = 0;

        for (let i = 1; i <= 10; i++) {
          status.innerText = `ğŸ“¸ Äang chá»¥p áº£nh ${i}/10...`;

          // Detect face
          const detections = await faceapi.detectAllFaces(
            video,
            new faceapi.TinyFaceDetectorOptions({
              inputSize: 224,
              scoreThreshold: 0.5,
            })
          );

          if (detections.length === 0) {
            status.innerText = `âš ï¸ KhÃ´ng phÃ¡t hiá»‡n khuÃ´n máº·t á»Ÿ áº£nh ${i}, tiáº¿p tá»¥c...`;
            await new Promise((r) => setTimeout(r, 600));
            continue;
          }

          // Láº¥y khuÃ´n máº·t lá»›n nháº¥t
          const largest = detections.reduce((prev, curr) =>
            curr.box.width * curr.box.height > prev.box.width * prev.box.height
              ? curr
              : prev
          );

          const box = largest.box;

          // ThÃªm padding 20%
          const padding = 0.2;
          const pw = box.width * padding;
          const ph = box.height * padding;

          const x = Math.max(0, box.x - pw);
          const y = Math.max(0, box.y - ph);
          const w = Math.min(canvas.width - x, box.width + 2 * pw);
          const h = Math.min(canvas.height - y, box.height + 2 * ph);

          // Váº½ full frame
          ctx.drawImage(video, 0, 0);

          // Crop face
          const faceCanvas = document.createElement("canvas");
          faceCanvas.width = w;
          faceCanvas.height = h;
          const faceCtx = faceCanvas.getContext("2d");
          faceCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

          // Convert to blob
          const blob = await new Promise((res) =>
            faceCanvas.toBlob(res, "image/jpeg", 0.95)
          );

          images.push(blob);
          successCount++;

          await new Promise((r) => setTimeout(r, 600));
        }

        if (successCount < 5) {
          status.innerHTML = `<span class='text-danger'>âŒ Chá»‰ chá»¥p Ä‘Æ°á»£c ${successCount}/10 áº£nh cÃ³ khuÃ´n máº·t. Cáº§n Ã­t nháº¥t 5 áº£nh!</span>`;

          // Khá»Ÿi Ä‘á»™ng láº¡i bbox detection
          if (faceApiLoaded) {
            const overlayCanvas = qs("face-overlay-canvas");
            faceDetectionInterval = setInterval(() => {
              drawFaceBoxes(video, overlayCanvas);
            }, 100);
          }
          return;
        }

        // Dá»«ng camera
        if (cameraStream) {
          cameraStream.getTracks().forEach((t) => t.stop());
          cameraStream = null;
        }

        status.innerText = `â³ Äang xá»­ lÃ½ Ä‘Äƒng kÃ½ ${successCount} áº£nh khuÃ´n máº·t...`;

        const fd = new FormData();
        fd.append("student_id", studentId);
        fd.append("name", name);
        images.forEach((b, i) => fd.append("images", b, `face_${i}.jpg`));

        try {
          const res = await fetch("/api/students/register/camera", {
            method: "POST",
            body: fd,
          });
          const data = await res.json();

          if (res.ok) {
            status.innerHTML = `<span class="text-success">âœ… ${data.message}</span>`;
            result.innerHTML = `<div class="alert alert-success mt-2">
              <strong>âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng!</strong><br>
              MSSV: ${studentId}<br>
              Há» tÃªn: ${name}<br>
              Sá»‘ áº£nh: ${successCount}<br>
              Máº­t kháº©u máº·c Ä‘á»‹nh: <strong>123456</strong>
            </div>`;

            // Reset form
            qs("form-register-camera").reset();

            // ÄÃ³ng modal sau 3 giÃ¢y
            setTimeout(() => {
              bootstrap.Modal.getInstance(qs("cameraModal"))?.hide();
            }, 3000);
          } else {
            status.innerHTML = `<span class="text-danger">âŒ ${
              data.error || "Lá»—i Ä‘Äƒng kÃ½"
            }</span>`;
            result.innerHTML = `<span class="text-danger">âŒ ${
              data.error || "Lá»—i Ä‘Äƒng kÃ½"
            }</span>`;
          }
        } catch (err) {
          console.error(err);
          status.innerHTML = "<span class='text-danger'>âŒ Lá»—i káº¿t ná»‘i</span>";
          result.innerHTML =
            "<span class='text-danger'>âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n server</span>";
        }
      });

      /* ======================= ZIP IMPORT ======================= */
      qs("form-register-zip").addEventListener("submit", async (e) => {
        e.preventDefault();
        const result = qs("zip-result");
        const formData = new FormData(e.target);

        result.innerHTML = "<span class='text-info'>â³ Äang xá»­ lÃ½...</span>";

        try {
          const res = await fetch("/api/students/register/zip", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();

          if (res.ok) {
            let html =
              "<div class='text-success'><strong>âœ… Káº¿t quáº£ import:</strong><ul>";
            data.forEach((item) => {
              html += `<li>${item.student_id} - ${item.name}: ${item.status}</li>`;
            });
            html += "</ul></div>";
            result.innerHTML = html;
          } else {
            result.innerHTML = `<span class='text-danger'>âŒ ${
              data.error || "Lá»—i import"
            }</span>`;
          }
        } catch (err) {
          console.error(err);
          result.innerHTML = "<span class='text-danger'>âŒ Lá»—i káº¿t ná»‘i</span>";
        }
      });

      /* ======================= EVENTS (ONE PLACE) ======================= */
      document.addEventListener("DOMContentLoaded", () => {
        loadCourses();

        document.querySelectorAll(".sidebar a[data-tab]").forEach((a) => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            showTab(a.dataset.tab);

            if (a.dataset.tab === "statistics" && currentCourseId)
              loadStatistics(currentCourseId);
          });
        });

        qs("btn-open-course-modal").addEventListener("click", () =>
          openCourseModal()
        );
        qs("btn-open-import").addEventListener("click", () =>
          openImportStudentsModal()
        );

        qs("btn-open-attendance").addEventListener("click", () =>
          openAttendanceModal()
        );
        qs("btn-close-attendance").addEventListener("click", () =>
          closeAttendanceModal()
        );
        qs("btn-close-attendance-x").addEventListener("click", () =>
          closeAttendanceModal()
        );

        qs("btn-show-qr").addEventListener("click", () => {
          if (!currentCourseId)
            return showToast("âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c", "danger");
          showQR(currentCourseId, currentCourseName);
        });

        qs("btn-start-register").addEventListener("click", () =>
          captureAndSend()
        );

        qs("tab-statistics").addEventListener("click", () => {
          if (currentCourseId) loadStatistics(currentCourseId);
          else showToast("âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c", "danger");
        });

        qs("btn-export-stat").addEventListener("click", () =>
          exportStatistics()
        );
      });
    </script>
  </body>
</html>
