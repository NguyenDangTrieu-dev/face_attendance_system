<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Giáº£ng ViÃªn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #f8f9fa;
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            width: 250px;
            background-color: #343a40;
            padding-top: 60px;
            color: white;
        }
        .sidebar h5 {
            padding-left: 20px;
            margin-bottom: 30px;
        }
        .sidebar a {
            padding: 12px 20px;
            display: block;
            color: white;
            text-decoration: none;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
            min-height: 100vh;
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
        }
        .list-group-item {
            border-left: 4px solid #0d6efd;
        }
        #attendance-video {
            width: 720px;
            height: auto;
            border-radius: 8px;
        }
    #attendance-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 720px;
        height: auto;
        pointer-events: none;
    }
    /* Style cho dropdown trong modal khÃ³a há»c */
    #courseModal .form-select {
        width: 100%;
    }
    #courseModal .row {
        display: flex;
        gap: 10px;
    }
    #courseModal .col {
        flex: 1;
    }
    /* Style cho modal import sinh viÃªn */
    #importStudentsModal .form-label {
        font-weight: bold;
    }
    #importStudentsModal .form-control[type="file"] {
        padding: 0.375rem 0.75rem;
    }
    #importStudentsModal .form-text {
        font-size: 0.875rem;
        color: #6c757d;
    }
    #importStudentsModal .btn-success {
        font-weight: 500;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>


<body>
<div class="modal fade" id="faceModal" tabindex="-1" aria-labelledby="faceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="faceModalLabel"> ÄÄƒng kÃ½ khuÃ´n máº·t</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
      </div>
      <div class="modal-body text-center">
        <video id="video" autoplay playsinline width="100%" style="max-height: 400px; border-radius: 8px;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <p class="mt-3" id="register-status"></p>
        <button class="btn btn-primary mt-2" onclick="captureAndSend()"> Báº¯t Äáº§u ÄÄƒng KÃ­</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="attendance-modal" tabindex="-1" aria-labelledby="attendanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="attendanceModalLabel">Äiá»ƒm danh realtime báº±ng khuÃ´n máº·t</h5>
        <button type="button" class="btn-close btn-close-white" onclick="closeAttendanceModal()"></button>
      </div>
      <div class="modal-body text-center">
        <div class="position-relative d-inline-block">
          <video id="attendance-video" autoplay muted playsinline class="rounded-3 border border-primary" style="width: 720px; height: auto;"></video>
          <canvas id="attendance-canvas" class="position-absolute top-0 start-0" style="pointer-events: none;"></canvas>
        </div>
        <div class="mt-3">
          <button class="btn btn-danger" onclick="closeAttendanceModal()">ÄÃ³ng</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal QR Code -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow rounded-4">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="qrModalLabel"> QuÃ©t mÃ£ QR Ä‘á»ƒ Ä‘iá»ƒm danh</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
      </div>
      <div class="modal-body text-center">
        <div id="qr-container" class="mb-3"></div>
        <p>HÃ£y dÃ¹ng á»©ng dá»¥ng Ä‘iá»ƒm danh Ä‘á»ƒ quÃ©t mÃ£ QR nÃ y.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal them sua-->
 <!-- Modal ThÃªm/Sá»­a khÃ³a há»c -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-labelledby="courseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="courseModalLabel">ğŸ“˜ ThÃªm/Sá»­a khÃ³a há»c</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <input type="hidden" id="courseId">
                    <div class="mb-3">
                        <label for="courseName" class="form-label">TÃªn khÃ³a há»c</label>
                        <input type="text" class="form-control" id="courseName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Há»c ká»³</label>
                        <div class="row">
                            <div class="col">
                                <select class="form-select" id="courseSemester" required>
                                    <option value="" disabled selected>Chá»n há»c ká»³</option>
                                    <option value="HK1">HK1</option>
                                    <option value="HK2">HK2</option>
                                </select>
                            </div>
                            <div class="col">
                                <select class="form-select" id="courseYear" required>
                                    <option value="" disabled selected>Chá»n nÄƒm</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="lecturerId" class="form-label">ID Giáº£ng viÃªn</label>
                        <input type="text" class="form-control" id="lecturerId" value="{{ user.user_id }}" readonly>
                    </div>
                    <button type="submit" class="btn btn-primary">LÆ°u</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!--Modal Import sinh vien tá»« excel-->
<!-- Modal Import Sinh viÃªn -->
<div class="modal fade" id="importStudentsModal" tabindex="-1" aria-labelledby="importStudentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="importStudentsModalLabel">ğŸ“¥ Import Sinh viÃªn tá»« Excel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
            </div>
            <div class="modal-body">
                <form id="importStudentsForm">
                    <div class="mb-3">
                        <label for="studentFile" class="form-label">Chá»n file Excel</label>
                        <input type="file" class="form-control" id="studentFile" accept=".xlsx, .xls" required>
                        <small class="form-text text-muted">File pháº£i chá»©a cÃ¡c cá»™t: <code>student_id</code>, <code>full_name</code>.</small>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Táº£i lÃªn</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal diem danh báº±ng hÃ¬nh anh-->
 <!-- Modal Upload Photos for Attendance -->
<div class="modal fade" id="uploadPhotosModal" tabindex="-1" aria-labelledby="uploadPhotosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="uploadPhotosModalLabel">ğŸ“¸ Táº£i lÃªn áº£nh Ä‘á»ƒ Ä‘iá»ƒm danh</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
            </div>
            <div class="modal-body">
                <form id="uploadPhotosForm">
                    <div class="mb-3">
                        <label for="photoFiles" class="form-label">Chá»n cÃ¡c áº£nh</label>
                        <input type="file" class="form-control" id="photoFiles" accept=".png, .jpg, .jpeg" multiple required>
                        <small class="form-text text-muted">Há»— trá»£ Ä‘á»‹nh dáº¡ng: PNG, JPG, JPEG. Má»—i áº£nh cÃ³ thá»ƒ chá»©a nhiá»u khuÃ´n máº·t.</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Táº£i lÃªn vÃ  Ä‘iá»ƒm danh</button>
                </form>
                <div id="upload-status" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
<!-- Sidebar -->
<!-- Sidebar -->
<div class="sidebar">
    <h5> Giáº£ng viÃªn: {{ user.full_name }}</h5>
    <a href="#" onclick="showTab('courses')"> KhÃ³a há»c</a>
    <a href="#" onclick="showTab('students')"> Sinh viÃªn</a>
    <a href="#" onclick="showTab('attendance')"> Lá»‹ch sá»­ Ä‘iá»ƒm danh</a>
    <a href="/logout" class="text-danger"> ÄÄƒng xuáº¥t</a>
</div>

<!-- Main Content -->
<div class="main-content">
    <ul class="nav nav-tabs" id="mainTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-courses" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab"> KhÃ³a há»c</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-students" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab"> Sinh viÃªn</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-attendance" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab"> Lá»‹ch sá»­ Ä‘iá»ƒm danh</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-statistics" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab">ğŸ“Š Thá»‘ng kÃª</button>
        </li>
    </ul>
<div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="courses" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>ğŸ“˜ Danh sÃ¡ch khÃ³a há»c</h5>
            <button class="btn btn-primary" onclick="openCourseModal()">â• ThÃªm khÃ³a há»c</button>
        </div>
        <div id="course-list" class="row"></div>
    </div>

    <div class="tab-pane fade" id="students" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 id="student-title" class="mb-0">ğŸ§‘â€ğŸ“ Danh sÃ¡ch sinh viÃªn - CÆ¡ sá»Ÿ dá»¯ liá»‡u vÃ  TrÃ­ tuá»‡ NhÃ¢n táº¡o</h5>
            <button class="btn btn-primary" onclick="openAttendanceModal()">ğŸ•µï¸â€â™‚ï¸ Äiá»ƒm danh realtime</button>
            <button class="btn btn-info ms-2" onclick="openUploadPhotosModal()">ğŸ“¸ Äiá»ƒm danh báº±ng áº£nh</button>
            <button onclick="showQR(currentCourseId, currentCourseName)">Hiá»‡n mÃ£ QR Ä‘iá»ƒm danh</button>
            <button class="btn btn-success ms-2" onclick="openImportStudentsModal()">ğŸ“¥ Import Sinh viÃªn</button>
            <div id="qr-box"></div>

        </div>
        <div id="student-list" class="list-group"></div>
    </div>

    <div class="tab-pane fade" id="attendance" role="tabpanel">
        <h5 id="attendance-title" class="mb-3"></h5>
        <div id="attendance-list" class="list-group"></div>
    </div>

    <div class="tab-pane fade" id="statistics" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>ğŸ“Š Thá»‘ng kÃª Ä‘iá»ƒm danh</h5>
            <button class="btn btn-secondary" onclick="exportStatistics()">ğŸ“¤ Xuáº¥t Excel</button>
        </div>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>MÃ£ SV</th>
                    <th>Há» tÃªn</th>
                    <th>Sá»‘ buá»•i Ä‘i há»c</th>
                    <th>Sá»‘ buá»•i váº¯ng</th>
                    <th>Tá»‰ lá»‡ Ä‘i há»c</th>
                </tr>
            </thead>
            <tbody id="statistics-body">
                <!-- Dá»¯ liá»‡u thá»‘ng kÃª sáº½ Ä‘Æ°á»£c thÃªm á»Ÿ Ä‘Ã¢y -->
            </tbody>
        </table>
        <h5 class="mt-4">ğŸ“ˆ Biá»ƒu Ä‘á»“ tá»‰ lá»‡ Ä‘iá»ƒm danh</h5>
        <canvas id="attendanceChart" width="400" height="200"></canvas>

    </div>
</div>

</div>

<script>
const lecturerId = "{{ user.user_id }}";

window.onload = function () {
    loadCourses();
};
let lastLoadedCourseId = null;
let currentCourseId = null;
let currentCourseName = '';
let isFetchingAttendance = false;
let lastTabSwitchTime = 0;
const debounceDelay = 300;
let isProgrammaticTabSwitch = false; // New flag

function showTab(tabId, courseId = null, courseName = '') {
    const now = Date.now();
    if (now - lastTabSwitchTime < debounceDelay) {
        console.log("Debouncing showTab call for tabId:", tabId);
        return;
    }
    lastTabSwitchTime = now;

    // Set the flag to indicate this is a programmatic call
    isProgrammaticTabSwitch = true;

    const tabButton = document.querySelector(`#tab-${tabId}`);
    if (!tabButton) {
        console.error(`KhÃ´ng tÃ¬m tháº¥y nÃºt tab vá»›i id: tab-${tabId}`);
        return;
    }
    const tab = new bootstrap.Tab(tabButton);
    tab.show();

    // Reset the flag after the tab is shown
    setTimeout(() => {
        isProgrammaticTabSwitch = false;
    }, 0);

    if (tabId === 'attendance') {
        if (courseId) {
            currentCourseId = courseId;
            currentCourseName = courseName;
        }

        const list = document.getElementById("attendance-list");
        const title = document.getElementById("attendance-title");

        if (!currentCourseId) {
            title.textContent = " Lá»‹ch sá»­ Ä‘iá»ƒm danh";
            list.innerHTML = "<p>Vui lÃ²ng chá»n má»™t khÃ³a há»c Ä‘á»ƒ xem lá»‹ch sá»­ Ä‘iá»ƒm danh.</p>";
            return;
        }

        if (lastLoadedCourseId === currentCourseId) {
            console.log(" Attendance Ä‘Ã£ Ä‘Æ°á»£c load rá»“i cho courseId:", currentCourseId);
            title.textContent = ` Lá»‹ch sá»­ Ä‘iá»ƒm danh - ${currentCourseName}`;
            return;
        }

        if (isFetchingAttendance) {
            console.log("Äang fetch attendance, bá» qua...");
            return;
        }

        loadAttendance(currentCourseId, currentCourseName);
    }
}
function loadAttendance(courseId, courseName) {
    if (isFetchingAttendance) {
        console.log("Äang fetch attendance, bá» qua...");
        return;
    }

    isFetchingAttendance = true;
    console.log("Loading attendance for courseId:", courseId);

    fetch(`/api/courses/${courseId}/attendance`)
        .then(res => {
            console.log("Fetch response status:", res.status);
            if (!res.ok) {
                throw new Error(`HTTP error: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log("Attendance data:", data);
            lastLoadedCourseId = courseId;

            const list = document.getElementById("attendance-list");
            const title = document.getElementById("attendance-title");
            if (!list || !title) {
                console.error("attendance-list or attendance-title element not found in DOM");
                return;
            }

            title.textContent = ` Lá»‹ch sá»­ Ä‘iá»ƒm danh - ${courseName}`;
            list.innerHTML = "";

            if (data.length === 0) {
                list.innerHTML = "<p>KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh.</p>";
                return;
            }

            data.forEach(att => {
                const div = document.createElement("div");
                div.className = "list-group-item";
                div.innerHTML = `
                    <strong>${att.student_name}</strong> |
                    <span>${new Date(att.time).toLocaleString('vi-VN', {
                        dateStyle: 'short',
                        timeStyle: 'short'
                    })}</span> |
                    ${att.recognized ? "<span class='text-success'> ÄÃ£ nháº­n diá»‡n</span>" : "<span class='text-danger'> ChÆ°a nháº­n</span>"}
                    ${att.image_base64 ? `<br><img src="${att.image_base64}" class="rounded mt-2" style="max-height: 100px;">` : ""}
                `;
                list.appendChild(div);
            });
        })
        .catch(err => {
            console.error("Error loading attendance:", err);
            const list = document.getElementById("attendance-list");
            if (list) {
                list.innerHTML = `<p class="text-danger">Lá»—i táº£i dá»¯ liá»‡u Ä‘iá»ƒm danh: ${err}</p>`;
            }
        })
        .finally(() => {
            isFetchingAttendance = false;
        });
}

function loadCourses() {
    fetch(`/api/lecturer/${lecturerId}/courses`)
        .then(res => res.json())
        .then(data => {
            const courseList = document.getElementById("course-list");
            courseList.innerHTML = "";
            data.forEach(course => {
                const col = document.createElement("div");
                col.className = "col-md-6 mb-3";
                col.innerHTML = `
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">${course.name}</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Há»c ká»³:</strong> ${course.semester}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadStudents(${course.id}, '${course.name}')">ğŸ‘¨â€ğŸ“ Xem SV</button>
                            <button class="btn btn-outline-secondary btn-sm ms-2"
                                onclick="showTab('attendance', ${course.id}, '${course.name}')">
                                ğŸ“ Lá»‹ch sá»­ Ä‘iá»ƒm danh
                            </button>
                            <button class="btn btn-outline-warning btn-sm ms-2"
                                onclick="openCourseModal({id: ${course.id}, name: '${course.name}', semester: '${course.semester}'})">
                                âœï¸ Sá»­a
                            </button>
                            <button class="btn btn-outline-danger btn-sm ms-2"
                                onclick="deleteCourse(${course.id})">
                                ğŸ—‘ï¸ XÃ³a
                            </button>
                        </div>
                    </div>
                `;
                courseList.appendChild(col);
            });
        })
        .catch(err => {
            console.error('Lá»—i khi táº£i danh sÃ¡ch khÃ³a há»c:', err);
            showToast('âŒ Lá»—i táº£i danh sÃ¡ch khÃ³a há»c', 'danger');
        });
}

function loadStudents(courseId, courseName) {
    currentCourseId = courseId;
    currentCourseName = courseName; // Set the course name
    fetch(`/api/courses/${courseId}/students_with_embedding`)
        .then(res => res.json())
        .then(data => {
            showTab('students');
            document.getElementById("student-title").textContent = ` Danh sÃ¡ch sinh viÃªn - ${courseName}`;
            const studentList = document.getElementById("student-list");
            studentList.innerHTML = "";

            data.forEach(st => {
                const div = document.createElement("div");
                div.className = "list-group-item d-flex justify-content-between align-items-center";

                const info = document.createElement("span");
                info.innerHTML = `<strong>${st.id}</strong> - ${st.full_name}`;

                const btn = document.createElement("button");
                btn.className = `btn btn-sm ${st.has_embedding ? 'btn-warning' : 'btn-primary'}`;
                btn.innerHTML = st.has_embedding ? ' ÄÄƒng kÃ½ láº¡i' : ' ÄÄƒng kÃ½';
                btn.onclick = () => handleRegisterFace(st.id, st.full_name, st.has_embedding);

                div.appendChild(info);
                div.appendChild(btn);

                studentList.appendChild(div);
            });
        });
}
function showToast(message, type = 'success') {
    // Táº¡o container cho toast náº¿u chÆ°a cÃ³
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }

    // Táº¡o toast
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    setTimeout(() => {
        bsToast.hide();
        toast.remove();
    }, 3000);
}

function showQR(courseId, courseName) {
    const qrContainer = document.getElementById("qr-container");
    qrContainer.innerHTML = "";

    const img = document.createElement("img");
    img.src = `/api/qr_ip?course_id=${encodeURIComponent(courseId)}&course_name=${encodeURIComponent(courseName)}`;
    img.alt = "QR chá»©a thÃ´ng tin Ä‘iá»ƒm danh";
    img.style.width = "256px";
    img.style.height = "256px";

    img.onload = () => {
        qrContainer.appendChild(img);
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        qrModal.show();
    };
    img.onerror = () => {
        qrContainer.innerHTML = "<p class='text-danger'>Lá»—i: KhÃ´ng thá»ƒ táº£i mÃ£ QR</p>";
        const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        qrModal.show();
    };
}

let currentStudentId = null;
let currentStudentName = null;
let stream = null;

async function handleRegisterFace(studentId, fullName, hasEmbedding) {
    currentStudentId = studentId;
    currentStudentName = fullName;

    const modal = new bootstrap.Modal(document.getElementById('faceModal'));
    modal.show();

    const video = document.getElementById('video');
    try {
        stream = await setupWebcam(video);
    } catch (err) {
        console.error("Failed to setup webcam in handleRegisterFace:", err);
        const status = document.getElementById('register-status');
        status.innerHTML = "<span class='text-danger'> KhÃ´ng thá»ƒ truy cáº­p webcam</span>";
    }
}

    function captureAndSend() {
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const status = document.getElementById("register-status");
        const ctx = canvas.getContext('2d');

        const capturedImages = [];
        let count = 0;
        const totalCaptures = 10;
        const delay = 600; // 0.6 giÃ¢y

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        status.innerHTML = "<span class='text-info'> Äang chá»¥p áº£nh...</span>";

        const capture = () => {
            ctx.drawImage(video, 0, 0);
            canvas.toBlob(blob => {
                capturedImages.push(blob);
                count++;

                if (count < totalCaptures) {
                    setTimeout(capture, delay); // chá»¥p tiáº¿p
                } else {
                    // Gá»­i táº¥t cáº£ áº£nh lÃªn server
                    const formData = new FormData();
                    formData.append("student_id", currentStudentId);
                    formData.append("name", currentStudentName);
                    for (let i = 0; i < capturedImages.length; i++) {
                        formData.append("files", capturedImages[i], `frame_${i}.jpg`);
                    }

                    fetch('/register', {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            status.innerHTML = "<span class='text-success'> ÄÄƒng kÃ½ thÃ nh cÃ´ng!</span>";
                        } else {
                            status.innerHTML = "<span class='text-danger'> ÄÄƒng kÃ½ tháº¥t báº¡i: " + result.message + "</span>";
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        status.innerHTML = "<span class='text-danger'> Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§</span>";
                    });
                }
            }, 'image/jpeg');
        };

        capture(); // báº¯t Ä‘áº§u chá»¥p áº£nh
    }
    // ÄÃ³ng modal vÃ  dá»«ng webcam
    document.getElementById("faceModal").addEventListener('hidden.bs.modal', () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });

    async function setupWebcam(videoElement) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            await new Promise(resolve => {
                videoElement.onloadedmetadata = () => {
                    videoElement.play(); // Ensure the video plays after metadata is loaded
                    resolve();
                };
            });
            return stream;
        } catch (err) {
            alert("KhÃ´ng thá»ƒ truy cáº­p webcam!");
            console.error("Webcam error:", err);
            throw err; // Rethrow to handle in the calling function
        }
    }
    async function openAttendanceModal() {
    const video = document.getElementById('attendance-video');
    const canvas = document.getElementById('attendance-canvas');
    const context = canvas.getContext('2d');

    if (!currentCourseId) {
        alert("Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c khi Ä‘iá»ƒm danh!");
        return;
    }

    if (window.attendanceStream) {
        window.attendanceStream.getTracks().forEach(track => track.stop());
        window.attendanceStream = null;
    }
    if (window.attendanceInterval) {
        clearInterval(window.attendanceInterval);
        window.attendanceInterval = null;
    }

    const modal = new bootstrap.Modal(document.getElementById('attendance-modal'));
    modal.show();

    try {
        const stream = await setupWebcam(video);
        window.attendanceStream = stream;

        video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        console.log("Canvas size:", canvas.width, canvas.height);
        console.log("Video size:", video.videoWidth, video.videoHeight);

        let lastRecognitions = []; // LÆ°u trá»¯ nhiá»u khuÃ´n máº·t
        let lastRecognitionTime = 0;
        const PERSISTENCE_DURATION = 3000;

        window.attendanceInterval = setInterval(() => {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('file', blob, 'frame.jpg');
                formData.append('course_id', currentCourseId);

                fetch('/recognize_siamese', {
                    method: 'POST',
                    body: formData
                })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
                    return res.json();
                })
                .then(data => {
                    console.log("API response:", data);
                    if (data.error) {
                        console.warn("Lá»—i nháº­n diá»‡n:", data.error);
                        return;
                    }
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(result => {
                            const name = result.name;
                            showToast(`ÄÃ£ Ä‘iá»ƒm danh: ${name}`);
                        });
                        lastRecognitions = data; // LÆ°u toÃ n bá»™ káº¿t quáº£
                        lastRecognitionTime = Date.now();
                    } else {
                        console.warn("No recognition data:", data);
                    }
                })
                .catch(err => console.error("Lá»—i gá»­i API:", err));
            }, 'image/jpeg', 0.9);

            const currentTime = Date.now();
            if (lastRecognitions.length > 0 && (currentTime - lastRecognitionTime) < PERSISTENCE_DURATION) {
                lastRecognitions.forEach(recognition => {
                    const bbox = recognition.bbox;
                    const name = recognition.name;
                    const similarity = recognition.similarity ? `(${recognition.similarity * 100}%)` : '';

                    if (!Array.isArray(bbox) || bbox.length !== 4) {
                        console.warn("Invalid bbox format:", bbox);
                        return;
                    }

                    console.log("Drawing box:", { startX: bbox[0], startY: bbox[1], endX: bbox[2], endY: bbox[3], name });

                    const scaleX = canvas.width / video.videoWidth;
                    const scaleY = canvas.height / video.videoHeight;

                    const scaledStartX = bbox[0] * scaleX;
                    const scaledStartY = bbox[1] * scaleY;
                    const scaledEndX = bbox[2] * scaleX;
                    const scaledEndY = bbox[3] * scaleY;
                    const width = scaledEndX - scaledStartX;
                    const height = scaledEndY - scaledStartY;

                    if (isNaN(scaledStartX) || isNaN(scaledStartY) || isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                        console.warn("Invalid box coordinates:", { scaledStartX, scaledStartY, width, height });
                        return;
                    }

                    // Váº½ khung viá»n
                    context.strokeStyle = 'green';
                    context.lineWidth = 4;
                    context.beginPath();
                    context.rect(scaledStartX, scaledStartY, width, height);
                    context.stroke();

                    // ThÃªm tÃªn vÃ  Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng
                    context.fillStyle = 'green';
                    context.font = '20px Arial';
                    context.fillText(`${name} ${similarity}`, scaledStartX, scaledStartY - 10);
                });
            } else {
                console.log("No valid recognitions to draw");
            }
        }, 500);
    } catch (error) {
        console.error("KhÃ´ng thá»ƒ má»Ÿ webcam:", error);
        alert("KhÃ´ng thá»ƒ má»Ÿ webcam!");
    }
}

    function closeAttendanceModal() {
        const modalEl = document.getElementById('attendance-modal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        if (window.attendanceStream) {
            window.attendanceStream.getTracks().forEach(track => track.stop());
            window.attendanceStream = null;
        }

        if (window.attendanceInterval) {
            clearInterval(window.attendanceInterval);
            window.attendanceInterval = null;
        }
        const video = document.getElementById('attendance-video');
        video.srcObject = null;

        // Clear the canvas
        const canvas = document.getElementById('attendance-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }


function populateYears() {
    const yearSelect = document.getElementById('courseYear');
    yearSelect.innerHTML = '<option value="" disabled selected>Chá»n nÄƒm</option>';
    const currentYear = new Date().getFullYear(); // Láº¥y nÄƒm hiá»‡n táº¡i (2025)
    const startYear = 2020; // NÄƒm báº¯t Ä‘áº§u (cÃ³ thá»ƒ Ä‘iá»u chá»‰nh náº¿u cáº§n)
    const endYear = currentYear + 1; // ThÃªm nÄƒm tiáº¿p theo (2026)
    for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
    }
}
// Gá»i API Ä‘á»ƒ táº¡o khÃ³a há»c
function createCourse(courseData) {
    fetch('/api/courses', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(courseData)
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.error) {
            showToast(`âŒ Lá»—i: ${data.error}`, 'danger');
        } else {
            showToast('âœ… ThÃªm khÃ³a há»c thÃ nh cÃ´ng', 'success');
            loadCourses(); // Táº£i láº¡i danh sÃ¡ch khÃ³a há»c
            bootstrap.Modal.getInstance(document.getElementById('courseModal')).hide();
        }
    })
    .catch(err => {
        console.error('Lá»—i khi táº¡o khÃ³a há»c:', err);
        showToast('âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§', 'danger');
    });
}

function deleteCourse(courseId) {
    if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a khÃ³a há»c nÃ y?')) return;

    fetch(`/api/courses/${courseId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.error) {
            showToast(`âŒ Lá»—i: ${data.error}`, 'danger');
        } else {
            showToast('âœ… XÃ³a khÃ³a há»c thÃ nh cÃ´ng', 'success');
            loadCourses(); // Táº£i láº¡i danh sÃ¡ch khÃ³a há»c
        }
    })
    .catch(err => {
        console.error('Lá»—i khi xÃ³a khÃ³a há»c:', err);
        showToast('âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§', 'danger');
    });
}
// Gá»i API Ä‘á»ƒ sá»­a khÃ³a há»c
function updateCourse(courseId, courseData) {
    fetch(`/api/courses/${courseId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(courseData)
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP error: ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.error) {
            showToast(`âŒ Lá»—i: ${data.error}`, 'danger');
        } else {
            showToast('âœ… Cáº­p nháº­t khÃ³a há»c thÃ nh cÃ´ng', 'success');
            loadCourses(); // Táº£i láº¡i danh sÃ¡ch khÃ³a há»c
            bootstrap.Modal.getInstance(document.getElementById('courseModal')).hide();
        }
    })
    .catch(err => {
        console.error('Lá»—i khi cáº­p nháº­t khÃ³a há»c:', err);
        showToast('âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§', 'danger');
    });
}
function openCourseModal(course = null) {
    const modal = new bootstrap.Modal(document.getElementById('courseModal'));
    const form = document.getElementById('courseForm');
    const courseIdInput = document.getElementById('courseId');
    const courseNameInput = document.getElementById('courseName');
    const courseSemesterSelect = document.getElementById('courseSemester');
    const courseYearSelect = document.getElementById('courseYear');
    const modalTitle = document.getElementById('courseModalLabel');

    // Äiá»n danh sÃ¡ch nÄƒm
    populateYears();

    if (course) {
        // Sá»­a khÃ³a há»c
        modalTitle.textContent = 'ğŸ“˜ Sá»­a khÃ³a há»c';
        courseIdInput.value = course.id;
        courseNameInput.value = course.name;
        const [semester, year] = course.semester ? course.semester.split('-') : ['', ''];
        courseSemesterSelect.value = semester || '';
        courseYearSelect.value = year || '';
    } else {
        // ThÃªm khÃ³a há»c má»›i
        modalTitle.textContent = 'ğŸ“˜ ThÃªm khÃ³a há»c';
        courseIdInput.value = '';
        courseNameInput.value = '';
        courseSemesterSelect.value = '';
        courseYearSelect.value = '';
    }

    modal.show();

    form.onsubmit = function (e) {
        e.preventDefault();
        if (!courseNameInput.value || !courseSemesterSelect.value || !courseYearSelect.value) {
            showToast('âŒ Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin', 'danger');
            return;
        }

        const courseId = courseIdInput.value;
        const semester = `${courseSemesterSelect.value}-${courseYearSelect.value}`;
        const courseData = {
            name: courseNameInput.value,
            semester: semester,
            lecturer_id: lecturerId
        };

        if (courseId) {
            updateCourse(courseId, courseData);
        } else {
            createCourse(courseData);
        }
    };
}
function openImportStudentsModal() {
    if (!currentCourseId) {
        showToast('âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c', 'danger');
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('importStudentsModal'));
    const form = document.getElementById('importStudentsForm');
    const fileInput = document.getElementById('studentFile');

    // Reset form khi má»Ÿ modal
    form.reset();

    modal.show();

    // Xá»­ lÃ½ submit form
    form.onsubmit = function (e) {
        e.preventDefault();
        const file = fileInput.files[0];
        console.log('Selected file:', file); // Debug
        if (!file || !file.name) {
            showToast('âŒ Vui lÃ²ng chá»n file Excel', 'danger');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        console.log('Sending request to:', `/api/courses/${currentCourseId}/import_students`); // Debug

        fetch(`/api/courses/${currentCourseId}/import_students`, {
            method: 'POST',
            body: formData
        })
        .then(res => {
            console.log('Response status:', res.status); // Debug
            if (!res.ok) {
                throw new Error(`HTTP error: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('Response data:', data); // Debug
            if (data.error) {
                showToast(`âŒ Lá»—i: ${data.error}`, 'danger');
            } else {
                showToast('âœ… Import sinh viÃªn thÃ nh cÃ´ng', 'success');
                loadStudents(currentCourseId, currentCourseName); // Táº£i láº¡i danh sÃ¡ch sinh viÃªn
                modal.hide(); // ÄÃ³ng modal
            }
        })
        .catch(err => {
            console.error('Lá»—i khi import sinh viÃªn:', err);
            showToast('âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§', 'danger');
        });
    };
}
let attendanceChart = null;

function loadStatistics(courseId) {
  if (!courseId) {
    showToast('âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c', 'danger');
    return;
  }

  const tbody = document.getElementById("statistics-body");
  tbody.innerHTML = `<tr><td colspan="4">â³ Äang táº£i dá»¯ liá»‡u...</td></tr>`;

  fetch(`/api/courses/${courseId}/attendance/summary`)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
      return res.json();
    })
    .then(data => {
      tbody.innerHTML = ""; 

      if (data.length === 0) {
        showToast('â„¹ï¸ KhÃ³a há»c chÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm danh.', 'info');
        return;
      }

      const labels = [];
      const attendedData = [];
      const absentData = [];

      data.forEach(stat => {
        labels.push(stat.full_name);
        attendedData.push(stat.attended);
        absentData.push(stat.absent);

        const row = document.createElement("tr");
        const total = stat.attended + stat.absent;
        const ratio = total === 0 ? 0 : (stat.attended / total * 100).toFixed(2);
        row.innerHTML = `
        <td>${stat.student_id}</td>
        <td>${stat.full_name}</td>
        <td>${stat.attended}</td>
        <td>${stat.absent}</td>
        <td>${ratio}%</td>
        `;
        tbody.appendChild(row);
      });
        const ratioData = data.map(stat => {
        const total = stat.attended + stat.absent;
        return total === 0 ? 0 : (stat.attended / total * 100).toFixed(2); // pháº§n trÄƒm
        });

        // Váº½ biá»ƒu Ä‘á»“ Ä‘Æ°á»ng
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        if (attendanceChart) {
        attendanceChart.destroy();
        }
        attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels, // tÃªn sinh viÃªn
            datasets: [{
            label: 'Tá»‰ lá»‡ Ä‘i há»c (%)',
            data: ratioData,
            fill: false,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.4)',
            tension: 0.3,
            pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
            legend: { position: 'top' },
            title: {
                display: true,
                text: 'Biá»ƒu Ä‘á»“ tá»‰ lá»‡ sinh viÃªn Ä‘i há»c (%)'
            },
            tooltip: {
                callbacks: {
                label: function(context) {
                    return context.raw + '%';
                }
                }
            }
            },
            scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                display: true,
                text: 'Tá»‰ lá»‡ (%)'
                }
            },
            x: {
                ticks: {
                maxRotation: 45,
                minRotation: 45,
                autoSkip: false
                }
            }
            }
        }
        });
    })
    .catch(err => {
      console.error('Lá»—i khi táº£i thá»‘ng kÃª:', err);
      showToast('âŒ Lá»—i táº£i dá»¯ liá»‡u thá»‘ng kÃª', 'danger');
    });
}


function exportStatistics() {
    if (!currentCourseId) {
        showToast('âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c', 'danger');
        return;
    }

    // Láº¥y dá»¯ liá»‡u tá»« báº£ng thá»‘ng kÃª
    const tbody = document.getElementById("statistics-body");
    const rows = tbody.getElementsByTagName("tr");
    if (rows.length === 0 || tbody.innerHTML.includes("Äang táº£i dá»¯ liá»‡u...")) {
        showToast('âŒ ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª Ä‘á»ƒ xuáº¥t', 'danger');
        return;
    }

    const data = [];
    // ThÃªm tiÃªu Ä‘á» cá»™t
    const headers = ["MÃ£ SV", "Há» tÃªn", "Sá»‘ buá»•i Ä‘i há»c", "Sá»‘ buá»•i váº¯ng", "Tá»‰ lá»‡ Ä‘i há»c (%)"];
    data.push(headers);

    // Láº¥y dá»¯ liá»‡u tá»« cÃ¡c hÃ ng
    for (let row of rows) {
        if (!row.innerHTML.includes("Äang táº£i dá»¯ liá»‡u...")) {
            const cols = row.getElementsByTagName("td");
            const rowData = [];
            for (let col of cols) {
                rowData.push(col.textContent.trim());
            }
            data.push(rowData);
        }
    }

    if (data.length <= 1) { // Chá»‰ cÃ³ tiÃªu Ä‘á», khÃ´ng cÃ³ dá»¯ liá»‡u
        showToast('âŒ ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª Ä‘á»ƒ xuáº¥t', 'danger');
        return;
    }

    // Táº¡o workbook vÃ  worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh Ä‘á»™ rá»™ng cá»™t dá»±a trÃªn ná»™i dung
    const colWidths = data[0].map((_, colIdx) => {
        return Math.max(...data.map(row => (row[colIdx] ? row[colIdx].toString().length : 0))) + 2;
    });
    ws['!cols'] = colWidths.map(wch => ({ wch }));

    // Äá»‹nh dáº¡ng tiÃªu Ä‘á» vá»›i gradient mÃ u
    const headerRange = XLSX.utils.decode_range(ws['!ref']);
    headerRange.s.r = 0; // DÃ²ng Ä‘áº§u tiÃªn
    headerRange.e.r = 0; // Chá»‰ Ä‘á»‹nh dáº¡ng dÃ²ng tiÃªu Ä‘á»
    const headerStyle = {
        font: { name: "Calibri", bold: true, color: { rgb: "FFFFFF" } },
        fill: {
            patternType: "gradient",
            fgColor: { rgb: "4F81BD" }, // MÃ u xanh Ä‘áº­m
            bgColor: { rgb: "ADD8E6" }  // MÃ u xanh nháº¡t
        },
        alignment: { horizontal: "center", vertical: "middle" },
        border: {
            top: { style: "medium" },
            bottom: { style: "medium" },
            left: { style: "medium" },
            right: { style: "medium" }
        }
    };
    const range = XLSX.utils.encode_range(headerRange);
    const headerCells = [];
    for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
        if (!ws[cellAddress]) ws[cellAddress] = { v: data[0][C] };
        headerCells.push(ws[cellAddress]);
    }
    headerCells.forEach(cell => {
        if (!cell.s) cell.s = {};
        Object.assign(cell.s, headerStyle);
    });

    // Äá»‹nh dáº¡ng dá»¯ liá»‡u vá»›i viá»n Ä‘áº¹p vÃ  Ä‘á»‹nh dáº¡ng sá»‘
    const dataRange = XLSX.utils.decode_range(ws['!ref']);
    dataRange.s.r = 1; // Báº¯t Ä‘áº§u tá»« dÃ²ng thá»© 2 (dá»¯ liá»‡u)
    const dataStyle = {
        alignment: { horizontal: "center", vertical: "middle" },
        border: {
            top: { style: "thin" },
            bottom: { style: "thin" },
            left: { style: "thin" },
            right: { style: "thin" }
        }
    };
    for (let R = dataRange.s.r; R <= dataRange.e.r; ++R) {
        for (let C = dataRange.s.c; C <= dataRange.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cellAddress]) ws[cellAddress] = { v: data[R][C] };
            if (!ws[cellAddress].s) ws[cellAddress].s = {};
            Object.assign(ws[cellAddress].s, dataStyle);
            // Äá»‹nh dáº¡ng cá»™t "Tá»‰ lá»‡ Ä‘i há»c (%)" vá»›i kÃ½ hiá»‡u %
            if (C === 4 && ws[cellAddress].v) {
                ws[cellAddress].z = "0.00%"; // Äá»‹nh dáº¡ng sá»‘ vá»›i 2 chá»¯ sá»‘ tháº­p phÃ¢n
                ws[cellAddress].v = parseFloat(ws[cellAddress].v) / 100; // Chuyá»ƒn % vá» giÃ¡ trá»‹ tháº­p phÃ¢n (Excel sáº½ tá»± nhÃ¢n 100)
            }
        }
    }

    // ThÃªm tiÃªu Ä‘á» phá»¥ (tuá»³ chá»n)
    ws['A1'] = { v: `BÃO CÃO THá»NG KÃŠ ÄIá»‚M DANH - ${currentCourseName}`, t: "s" };
    ws['A1'].s = {
        font: { name: "Calibri", bold: true, size: 14, color: { rgb: "000000" } },
        alignment: { horizontal: "center", vertical: "middle" }
    };
    XLSX.utils.sheet_add_aoa(ws, [[]], { origin: "A2" }); // Dá»‹ch dÃ²ng xuá»‘ng 1 Ä‘á»ƒ chá»«a chá»— cho tiÃªu Ä‘á»

    // ThÃªm worksheet vÃ o workbook
    XLSX.utils.book_append_sheet(wb, ws, "ThongKeDiemDanh");

    // Táº¡o file Excel vÃ  táº£i xuá»‘ng
    const currentDate = new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }).replace(/[,/:]/g, '-');
    const fileName = `ThongKe_DiemDanh_${currentCourseName}_${currentCourseId}_${currentDate}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showToast('âœ… Xuáº¥t file Excel thÃ nh cÃ´ng', 'success');
}

document.getElementById("tab-statistics").addEventListener("click", () => {
  if (typeof currentCourseId !== "undefined" && currentCourseId) {
    loadStatistics(currentCourseId);
  } else {
    showToast('âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c', 'danger');
  }
});


document.getElementById("tab-statistics").addEventListener("click", () => {
    if (currentCourseId) {
        loadStatistics(currentCourseId);
    }
});function openUploadPhotosModal() {
    if (!currentCourseId) {
        showToast('âŒ Vui lÃ²ng chá»n má»™t khÃ³a há»c trÆ°á»›c', 'danger');
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('uploadPhotosModal'));
    const form = document.getElementById('uploadPhotosForm');
    const fileInput = document.getElementById('photoFiles');
    const statusDiv = document.getElementById('upload-status');

    // Reset form vÃ  tráº¡ng thÃ¡i
    form.reset();
    statusDiv.innerHTML = '';

    modal.show();

    form.onsubmit = async function (e) {
        e.preventDefault();
        const files = fileInput.files;
        if (files.length === 0) {
            showToast('âŒ Vui lÃ²ng chá»n Ã­t nháº¥t má»™t áº£nh', 'danger');
            return;
        }

        // Kiá»ƒm tra Ä‘á»‹nh dáº¡ng vÃ  kÃ­ch thÆ°á»›c
        for (let file of files) {
            if (!['image/png', 'image/jpeg', 'image/jpg'].includes(file.type)) {
                showToast(`âŒ File ${file.name} khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng. Chá»‰ há»— trá»£ PNG, JPG, JPEG`, 'danger');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB
                showToast(`âŒ File ${file.name} quÃ¡ lá»›n. KÃ­ch thÆ°á»›c tá»‘i Ä‘a lÃ  5MB`, 'danger');
                return;
            }
        }

        statusDiv.innerHTML = '<span class="text-info">â³ Äang xá»­ lÃ½ Ä‘iá»ƒm danh...</span>';

        const formData = new FormData();
        formData.append('course_id', currentCourseId);
        for (let file of files) {
            formData.append('files', file);
        }

        try {
            const response = await fetch('/recognize_siamese_photos', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (response.ok) {
                if (data.length > 0) {
                    statusDiv.innerHTML = '<span class="text-success">ÄÃ£ nháº­n diá»‡n:</span><ul>';
                    data.forEach(result => {
                        if (result.name && result.name !== "Unknown") {
                            showToast(`âœ… ÄÃ£ Ä‘iá»ƒm danh: ${result.name} (${(result.similarity * 100).toFixed(2)}%)`, 'success');
                            statusDiv.innerHTML += `<li>${result.name} (${(result.similarity * 100).toFixed(2)}%)</li>`;
                        }
                    });
                    statusDiv.innerHTML += '</ul>';
                    if (!data.some(result => result.name !== "Unknown")) {
                        statusDiv.innerHTML = '<span class="text-warning">KhÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c ai trong áº£nh.</span>';
                    }
                } else {
                    statusDiv.innerHTML = '<span class="text-warning">KhÃ´ng nháº­n diá»‡n Ä‘Æ°á»£c ai trong áº£nh.</span>';
                }
            } else {
                statusDiv.innerHTML = `<span class="text-danger">Lá»—i: ${data.error}</span>`;
                showToast(`âŒ ${data.error}`, 'danger');
            }
        } catch (err) {
            console.error('Lá»—i khi gá»­i áº£nh:', err);
            statusDiv.innerHTML = '<span class="text-danger">Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§.</span>';
            showToast('âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§', 'danger');
        }
    };
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

